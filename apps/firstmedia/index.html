<!DOCTYPE html>
<html ng-app="MyApp">
<head>
    <title>FirstMedia Schedule</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.7/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.13/angular-ui-router.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.12.0/ui-bootstrap-tpls.min.js"></script>
</head>
<body class="container">

    <nav class="navbar navbar-default" role="navigation">
        <a class="navbar-brand" href="/">NNDDCC</a>
    </nav>

    <busy-indicator></busy-indicator>

    <h2>FirstMedia Schedule</h2>

    <br />

    <div ng-controller="MyCtrl">

        <form ng-submit="getschedule()" class="form-inline">

            <div class="form-group">
                <div class="input-group">
                    <input ng-model="data.showdate"
                           type="date" class="form-control" placeholder="Date" />
                </div>
            </div>

            <button type="submit" class="btn btn-default">Get</button>

        </form>

        <div>&nbsp;</div>

        <div>
            <span ng-repeat="channel in data.channels">

                <button ng-click="removeChannel(channel)" class="btn btn-danger">
                    {{channel}} <i class="fa fa-times"></i>
                </button>

            </span>

            <div>&nbsp;</div>

            <div class="form-group">
                <div class="input-group">
                    <input ng-model="vm.Channel"
                           type="text" class="form-control" placeholder="Add Channel"
                           typeahead="c.label + ' (' + c.id + ')' for c in vm.ChannelTypeAhead($viewValue)"
                           typeahead-on-select="vm.ChannelOnSelect($item, $model, $label)"
                           typeahead-editable="false" />
                </div>
            </div>
        </div>

        <table class="table" ng-repeat="channel in schedules">
            <caption>{{channel.Channel}}</caption>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Length</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="show in channel.Schedules">
                    <td>{{show.ShowTime}}</td>
                    <td>{{show.Title}}</td>
                    <td>{{show.Description}}</td>
                    <td>{{show.Length}}</td>
                </tr>
            </tbody>
        </table>

    </div>

    <script>
        "use strict";

        angular.module('MyApp', ['ui.router', 'ui.bootstrap']);

        angular.module("MyApp").controller("MyCtrl", [
            "$scope", "$http", "$q", "MyLocalStore", "BusyIndicatorHandler",
            function ($scope, $http, $q, MyLocalStore, BusyIndicatorHandler) {

                $scope.data = {
                    showdate: moment({ hour: 0 }).toDate()
                };

                var storeKey = "firstmediaSchedule.channels";
                var channels = MyLocalStore.get(storeKey);

                if (channels == null) {
                    $scope.data.channels = [];
                    MyLocalStore.set(storeKey, $scope.data.channels);
                } else {
                    $scope.data.channels = channels;
                };

                $scope.vm = {};

                $scope.vm.Channel = null;
                $scope.vm.ChannelTypeAhead = function (keyword) {
                    var filtered = _.filter($scope.channels, function (c) {
                        return c.label.toLowerCase().indexOf(keyword.toLowerCase()) > -1;
                    });
                    return filtered;
                };
                $scope.vm.ChannelOnSelect = function (item, model, label) {
                    $scope.data.channels.push(item.id);
                    $scope.data.channels = _($scope.data.channels).uniq().value().sort();
                    MyLocalStore.set(storeKey, $scope.data.channels);
                };

                $scope.removeChannel = function (channel) {
                    var idx = $scope.data.channels.indexOf(channel);
                    $scope.data.channels.splice(idx, 1);
                    MyLocalStore.set(storeKey, $scope.data.channels);
                };

                $scope.getschedule = function () {
                    var params = {
                        showdate: moment($scope.data.showdate).format("YYYY-MM-DD"),
                        channels: $scope.data.channels.join(",")
                    };
                    return $http({
                        method: "GET",
                        url: "https://uspcahharhjy5eb4.apphb.com/firstmedia/schedules",
                        params: params
                    }).then(function (response) {
                        $scope.schedules = response.data;
                        _.each($scope.schedules, function (c) {
                            _.each(c.Schedules, function (s) {
                                s.ShowTime = moment(s.ShowTime).format("ddd HH:mm");
                            });
                        });
                    });
                };

                BusyIndicatorHandler.show();

                $http({
                    method: "GET",
                    url: "https://uspcahharhjy5eb4.apphb.com/firstmedia/channels"
                }).then(function (response) {
                    $scope.channels = _.sortBy(response.data, function (c) {
                        return c.label;
                    });
                }).finally(function () {
                    BusyIndicatorHandler.hide();
                });

                if ($scope.data.channels.length > 0) {
                    $scope.getschedule();
                };

            }
        ]);

        angular.module("MyApp").directive("busyIndicator", [
            function () {
                var drctve = {
                    restrict: "E",
                    template: '' +
                        '<nav ng-show="status.visible"' +
                        ' class="navbar navbar-default navbar-fixed-bottom" role="navigation">' +
                        '<div class="container">' +
                        '<div class="navbar-header">' +
                        '<a class="navbar-brand">' +
                        '<i class="fa fa-refresh fa-spin"></i>' +
                        '</a>' +
                        '</div>' +
                        '</div>' +
                        '</nav>' +
                        '',
                    controller: [
                        "$scope", "BusyIndicatorHandler",
                        function ($scope, BusyIndicatorHandler) {
                            $scope.status = BusyIndicatorHandler;
                        }
                    ]
                };
                return drctve;
            }
        ]);

        angular.module("MyApp").factory("BusyIndicatorHandler", [
            function () {
                var handler = {};
                handler.visible = false;
                handler.show = function () { handler.visible = true; };
                handler.hide = function () { handler.visible = false; };
                return handler;
            }
        ]);

        angular.module("MyApp").factory("MyLocalStore", [
            function () {
                var svc = {};
                svc.get = function (keyword) {
                    var content = angular.fromJson(localStorage.getItem(keyword));
                    return content;
                };
                svc.set = function (keyword, value) {
                    var content = angular.toJson(value);
                    localStorage.setItem(keyword, content);
                };
                svc.remove = function (keyword) {
                    localStorage.removeItem(keyword);
                };
                svc.clear = function () {
                    localStorage.clear();
                };
                svc.keys = function () {
                    var keys = [];
                    for (var i = 0; i < localStorage.length; i++) {
                        var content = localStorage.key(i);
                        keys.push(content);
                    };
                    return keys;
                };
                return svc;
            }
        ]);

    </script>

</body>
</html>
