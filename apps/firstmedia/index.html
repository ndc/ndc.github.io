<!DOCTYPE html>
<html ng-app="MyApp">
<head>
    <title>FirstMedia Schedule</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.7/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.13/angular-ui-router.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.12.0/ui-bootstrap-tpls.min.js"></script>
</head>
<body class="container">

    <nav class="navbar navbar-default" role="navigation">
        <a class="navbar-brand" href="/">NNDDCC</a>
    </nav>

    <busy-indicator></busy-indicator>

    <h2>FirstMedia Schedule</h2>

    <br />

    <div ng-controller="MyCtrl">

        <div class="form-group">
            <label ng-repeat="chlist in settings.channelLists"
                   class="radio-inline">
                <input ng-model="settings.selectedList" ng-value="$index"
                       type="radio" />
                {{chlist.name}}
            </label>
        </div>

        <div class="form-group">
            <span ng-repeat="channel in settings.channelLists[settings.selectedList].channels">
                <button ng-click="removeChannel(channel)" class="btn btn-danger btn-xs">
                    {{channel}} <i class="fa fa-times"></i>
                </button>
            </span>
        </div>

        <div class="form-group">
            <input ng-model="vm.Channel"
                   type="text" class="form-control" placeholder="Add Channel"
                   typeahead="c.label + ' (' + c.id + ')' for c in vm.ChannelTypeAhead($viewValue)"
                   typeahead-on-select="vm.ChannelOnSelect($item, $model, $label)"
                   typeahead-editable="false" />
        </div>

        <form ng-submit="getschedule()" class="form-inline">

            <div class="form-group">
                <div class="input-group">
                    <input ng-model="data.showdate"
                           type="date" class="form-control" placeholder="Date" />
                </div>
            </div>

            &nbsp;

            <div class="checkbox">
                <label>
                    <input ng-model="settings.sortByTime" type="checkbox" ng-change="saveSortSetting()">
                    Sort by Time
                </label>
            </div>

            &nbsp;

            <button type="submit" class="btn btn-default">Get</button>

        </form>

        <div>&nbsp;</div>

        <table ng-repeat="channel in schedules" ng-hide="settings.sortByTime" class="table">
            <caption>{{channel.Channel}}</caption>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th class="text-right">Length</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="show in channel.Schedules">
                    <td>{{show.ShowTime | date:"EEE HH:mm"}}</td>
                    <td>{{show.Title}}</td>
                    <td>{{show.Description}}</td>
                    <td class="text-right">{{show.Length}}</td>
                </tr>
            </tbody>
        </table>

        <table ng-show="settings.sortByTime" class="table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Channel</th>
                    <th>Title</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="show in schedulesByTime">
                    <td>{{show.ShowTime | date:"EEE HH:mm"}}</td>
                    <td>{{show.Channel}}</td>
                    <td>{{show.Title}}</td>
                    <td>{{show.Description}}</td>
                </tr>
            </tbody>
        </table>

    </div>

    <script>
        "use strict";

        angular.module('MyApp', ['ui.router', 'ui.bootstrap']);

        angular.module("MyApp").controller("MyCtrl", [
            "$scope", "$http", "$q", "MyLocalStore", "BusyIndicatorHandler",
            function ($scope, $http, $q, MyLocalStore, BusyIndicatorHandler) {

                $scope.data = {
                    showdate: moment({ hour: 0 }).toDate()
                };

                var storeKey = "firstmediaSchedule";
                var storeKeySettings = storeKey + ".settings";

                $scope.clearSettings = function () {
                    MyLocalStore.clear();

                    $scope.settings = {
                        sortByTime: true,
                        channelLists: [
                            {
                                name: "chlist1",
                                channels: []
                            },
                            {
                                name: "chlist2",
                                channels: []
                            }
                        ]
                    };

                    $scope.settings.selectedList = 0;

                    MyLocalStore.set(storeKeySettings, $scope.settings);
                };

                $scope.settingsIsValid = function (settings) {
                    if (settings == null) {
                        return false;
                    };

                    if (typeof settings !== "object") {
                        return false;
                    };

                    if (!("channelLists" in settings)) {
                        return false;
                    };

                    if (!(settings.channelLists instanceof Array)) {
                        return false;
                    };

                    if (!("selectedList" in settings)) {
                        return false;
                    };

                    if (!("channels" in settings.channelLists[settings.selectedList])) {
                        return false;
                    };

                    return true;
                };

                try {
                    $scope.settings = MyLocalStore.get(storeKeySettings);
                } catch (exc) {
                    $scope.clearSettings();
                };

                if (!$scope.settingsIsValid($scope.settings)) {
                    $scope.clearSettings();
                };

                $scope.vm = {};

                $scope.vm.Channel = null;
                $scope.vm.ChannelTypeAhead = function (keyword) {
                    var filtered = _.filter($scope.channels, function (c) {
                        return c.label.toLowerCase().indexOf(keyword.toLowerCase()) > -1;
                    });
                    return filtered;
                };
                $scope.vm.ChannelOnSelect = function (item, model, label) {
                    var chlist = $scope.settings.channelLists[$scope.settings.selectedList];
                    chlist.channels.push(item.id);
                    chlist.channels = _(chlist.channels).uniq().value().sort();
                    MyLocalStore.set(storeKeySettings, $scope.settings);
                };

                $scope.saveSortSetting = function () {
                    MyLocalStore.set(storeKeySettings, $scope.settings);
                };

                $scope.removeChannel = function (channel) {
                    var chlist = $scope.settings.channelLists[$scope.settings.selectedList];
                    var idx = chlist.channels.indexOf(channel);
                    chlist.channels.splice(idx, 1);
                    MyLocalStore.set(storeKeySettings, $scope.settings);
                };

                $scope.getschedule = function () {
                    BusyIndicatorHandler.show();

                    var chlist = $scope.settings.channelLists[$scope.settings.selectedList];

                    var params = {
                        showdate: moment($scope.data.showdate).format("YYYY-MM-DD"),
                        channels: chlist.channels.join(",")
                    };

                    return $http({
                        method: "GET",
                        url: "https://uspcahharhjy5eb4.apphb.com/firstmedia/schedules",
                        params: params
                    }).then(function (response) {
                        $scope.schedules = response.data;

                        _.each($scope.schedules, function (c) {
                            _.each(c.Schedules, function (s) {
                                s.ShowTime = new Date(parseInt(s.ShowTime.substr(6)));
                            });
                        });

                        $scope.schedulesByTime = _(response.data).map(function (c) {
                            var sched = _.map(c.Schedules, function (s) {
                                return {
                                    ShowTime: s.ShowTime,
                                    Channel: c.Channel,
                                    Title: s.Title,
                                    Description: s.Description,
                                    Length: s.Length
                                };
                            });
                            return sched;
                        }).flatten().sortBy(["ShowTime", "Channel"]).value();
                    }).finally(function () {
                        BusyIndicatorHandler.hide();
                    });
                };

                $http({
                    method: "GET",
                    url: "https://uspcahharhjy5eb4.apphb.com/firstmedia/channels"
                }).then(function (response) {
                    $scope.channels = _.sortBy(response.data, function (c) {
                        return c.label;
                    });
                });

                if ($scope.settings.channelLists[$scope.settings.selectedList].channels.length > 0) {
                    $scope.getschedule();
                };

            }
        ]);

        angular.module("MyApp").directive("busyIndicator", [
            function () {
                var drctve = {
                    restrict: "E",
                    template: '' +
                        '<nav ng-show="status.visible"' +
                        ' class="navbar navbar-default navbar-fixed-bottom" role="navigation">' +
                        '<div class="container">' +
                        '<div class="navbar-header">' +
                        '<a class="navbar-brand">' +
                        '<i class="fa fa-refresh fa-spin"></i>' +
                        '</a>' +
                        '</div>' +
                        '</div>' +
                        '</nav>' +
                        '',
                    controller: [
                        "$scope", "BusyIndicatorHandler",
                        function ($scope, BusyIndicatorHandler) {
                            $scope.status = BusyIndicatorHandler;
                        }
                    ]
                };
                return drctve;
            }
        ]);

        angular.module("MyApp").factory("BusyIndicatorHandler", [
            function () {
                var handler = {};
                handler.visible = false;
                handler.show = function () { handler.visible = true; };
                handler.hide = function () { handler.visible = false; };
                return handler;
            }
        ]);

        angular.module("MyApp").factory("MyLocalStore", [
            function () {
                var svc = {};
                svc.get = function (keyword) {
                    var content = angular.fromJson(localStorage.getItem(keyword));
                    return content;
                };
                svc.set = function (keyword, value) {
                    var content = angular.toJson(value);
                    localStorage.setItem(keyword, content);
                };
                svc.remove = function (keyword) {
                    localStorage.removeItem(keyword);
                };
                svc.clear = function () {
                    localStorage.clear();
                };
                svc.keys = function () {
                    var keys = [];
                    for (var i = 0; i < localStorage.length; i++) {
                        var content = localStorage.key(i);
                        keys.push(content);
                    };
                    return keys;
                };
                return svc;
            }
        ]);

    </script>

</body>
</html>
